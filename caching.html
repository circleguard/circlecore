<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Advanced Usage" href="advanced-usage.html" /><link rel="prev" title="Loading" href="loading.html" />

    <meta name="generator" content="sphinx-3.5.2, furo 2021.03.20.beta30"/>
        <title>Caching - Circleguard v5.2.2 documentation</title>
      <link rel="stylesheet" href="_static/styles/furo.css?digest=978e1795dfe158b585dda6a8417f6411828bf3ed">
    <link rel="stylesheet" href="_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" href="_static/styles/furo-extensions.css?digest=d391b54134226e4196576da3bdb6dddb7e05ba2b"></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Circleguard v5.2.2 documentation</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">Circleguard v5.2.2 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Circlecore</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="foreword.html">Foreword</a></li>
<li class="toctree-l1"><a class="reference internal" href="representing-replays.html">Representing Replays</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-circleguard.html">Using Circleguard</a></li>
<li class="toctree-l1"><a class="reference internal" href="replay-containers.html">Replay Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="loading.html">Loading</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced-usage.html">Advanced Usage</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="caching">
<h1>Caching<a class="headerlink" href="#caching" title="Permalink to this headline">¶</a></h1>
<p>Because the replay_data api endpoint is heavily ratelimited (10/min), we provide replay caching in <a class="reference internal" href="appendix.html#circleguard.circleguard.Circleguard" title="circleguard.circleguard.Circleguard"><code class="xref py py-class docutils literal notranslate"><span class="pre">Circleguard</span></code></a>.
You can pass a <code class="docutils literal notranslate"><span class="pre">db_path</span></code> to <a class="reference internal" href="appendix.html#circleguard.circleguard.Circleguard" title="circleguard.circleguard.Circleguard"><code class="xref py py-class docutils literal notranslate"><span class="pre">Circleguard</span></code></a> and any replay it loads will be cached there. This cache lives in an
(sqlite) <code class="docutils literal notranslate"><span class="pre">.db</span></code> file and will persist across runs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cg</span> <span class="o">=</span> <span class="n">Circleguard</span><span class="p">(</span><span class="s2">"key"</span><span class="p">,</span> <span class="n">db_path</span><span class="o">=</span><span class="s2">"./cg_cache.db"</span><span class="p">)</span>
</pre></div>
</div>
<p>If the given path does not exist, circleguard will create fresh a db file there and use it. If the path is a
pre-existing databse file created by circleguard, that database will be used. Any other file existing at the path
will result in an error.</p>
<p>When loading a replay, we first check if the replay exists in the database, and load it from there if so. If not,
we load it from the api (or local file in the case of <a class="reference internal" href="appendix.html#circleguard.loadables.ReplayPath" title="circleguard.loadables.ReplayPath"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReplayPath</span></code></a>), compress the replays using
<a class="reference external" href="https://github.com/circleguard/wtc-lzma-compressor">WTC compression</a>, and store in the database.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">r1</span> <span class="o">=</span> <span class="n">ReplayMap</span><span class="p">(</span><span class="mi">221777</span><span class="p">,</span> <span class="mi">2757689</span><span class="p">)</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">ReplayMap</span><span class="p">(</span><span class="mi">221777</span><span class="p">,</span> <span class="mi">2757689</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"loading from api"</span><span class="p">)</span>
<span class="n">cg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span> <span class="c1"># replay gets loaded from the api and cached</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"loading from cache"</span><span class="p">)</span>
<span class="n">cg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span> <span class="c1"># loaded from our cache, not the api</span>
<span class="c1"># we can do this as many times as we want - we won't ever</span>
<span class="c1"># hit the api ratelimit since we're loading from the cache</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"loading from cache"</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ReplayMap</span><span class="p">(</span><span class="mi">221777</span><span class="p">,</span> <span class="mi">2757689</span><span class="p">)</span>
    <span class="n">cg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>WTC compression is lossy, so replays loaded from the api and loaded from cache will be slightly different.
The loss is on the order of 0.1 precision in the xy coordinate of frames, which is not enough to impact
the average use case, but could make a difference in some scenarios.</p>
</div>
<p>If you want to use a cache in “read only” mode (use previously cached replays, but don’t cache new replays), pass
<code class="docutils literal notranslate"><span class="pre">cache=False</span></code> to <a class="reference internal" href="appendix.html#circleguard.circleguard.Circleguard" title="circleguard.circleguard.Circleguard"><code class="xref py py-class docutils literal notranslate"><span class="pre">Circleguard</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cg</span> <span class="o">=</span> <span class="n">Circleguard</span><span class="p">(</span><span class="s2">"key"</span><span class="p">,</span> <span class="n">db_path</span><span class="o">=</span><span class="s2">"./db.db"</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="slider-dir">
<h2>slider_dir<a class="headerlink" href="#slider-dir" title="Permalink to this headline">¶</a></h2>
<p>We use <a class="reference external" href="https://github.com/llllllllll/slider">slider</a> to manage the download and parsing of beatmaps. We download beatmaps
when certain functions are called, such as <a class="reference internal" href="appendix.html#circleguard.circleguard.Circleguard.hits" title="circleguard.circleguard.Circleguard.hits"><code class="xref py py-func docutils literal notranslate"><span class="pre">cg.hits()</span></code></a>, that require the beatmap the replay was played on to work.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">slider_dir</span></code> is passed, downloaded beatmaps will be cached to that directory (which must exist). You can use the same
directory the <a class="reference internal" href="appendix.html#circleguard.circleguard.Circleguard" title="circleguard.circleguard.Circleguard"><code class="xref py py-class docutils literal notranslate"><span class="pre">Circleguard</span></code></a> cache db file is in if you’d like.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cg</span> <span class="o">=</span> <span class="n">Circleguard</span><span class="p">(</span><span class="s2">"key"</span><span class="p">,</span> <span class="n">db_path</span><span class="o">=</span><span class="s2">"./dbs/db.db"</span><span class="p">,</span> <span class="n">slider_dir</span><span class="o">=</span><span class="s2">"./dbs/"</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">ReplayMap</span><span class="p">(</span><span class="mi">221777</span><span class="p">,</span> <span class="mi">2757689</span><span class="p">)</span>
<span class="n">cg</span><span class="o">.</span><span class="n">hits</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c1"># downloads https://osu.ppy.sh/b/221777 and caches it in slider_dir</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">slider_dir</span></code> is not passed, we still use slider to download beatmaps, but cache them to a newly created temporary directory
instead. This means beatmaps will be cached with respect to a single <a class="reference internal" href="appendix.html#circleguard.circleguard.Circleguard" title="circleguard.circleguard.Circleguard"><code class="xref py py-class docutils literal notranslate"><span class="pre">Circleguard</span></code></a> object, but will not persist across runs.</p>
</div>
<div class="section" id="loadables">
<h2>Loadables<a class="headerlink" href="#loadables" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="appendix.html#circleguard.loadables.Replay" title="circleguard.loadables.Replay"><code class="xref py py-class docutils literal notranslate"><span class="pre">Replay</span></code></a> or <a class="reference internal" href="appendix.html#circleguard.loadables.ReplayContainer" title="circleguard.loadables.ReplayContainer"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReplayContainer</span></code></a> also has a <code class="docutils literal notranslate"><span class="pre">cache</span></code> parameter, which determines if it should be cached when loaded.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">cache</span></code> parameter has no effect if <a class="reference internal" href="appendix.html#circleguard.circleguard.Circleguard" title="circleguard.circleguard.Circleguard"><code class="xref py py-class docutils literal notranslate"><span class="pre">Circleguard</span></code></a> was not passed a <code class="docutils literal notranslate"><span class="pre">db_path</span></code> or if <a class="reference internal" href="appendix.html#circleguard.circleguard.Circleguard" title="circleguard.circleguard.Circleguard"><code class="xref py py-class docutils literal notranslate"><span class="pre">Circleguard</span></code></a> was
instantiated with <code class="docutils literal notranslate"><span class="pre">cache=False</span></code>.</p>
</div>
<p>This parameter is <code class="docutils literal notranslate"><span class="pre">True</span></code> by default, but by passing <code class="docutils literal notranslate"><span class="pre">False</span></code> we can selectively force certain loadables to not be cached
when they’re loaded:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cg</span> <span class="o">=</span> <span class="n">Circleguard</span><span class="p">(</span><span class="s2">"key"</span><span class="p">,</span> <span class="n">db_path</span><span class="o">=</span><span class="s2">"./db.db"</span><span class="p">)</span>
<span class="n">r1</span> <span class="o">=</span> <span class="n">ReplayMap</span><span class="p">(</span><span class="mi">221777</span><span class="p">,</span> <span class="mi">2757689</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">ReplayMap</span><span class="p">(</span><span class="mi">1524183</span><span class="p">,</span> <span class="mi">12092800</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span> <span class="c1"># gets cached</span>
<span class="n">cg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span> <span class="c1"># does not get cached</span>
</pre></div>
</div>
<p>For a <a class="reference internal" href="appendix.html#circleguard.loadables.ReplayContainer" title="circleguard.loadables.ReplayContainer"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReplayContainer</span></code></a>, <code class="docutils literal notranslate"><span class="pre">cache</span></code> cascades to its <a class="reference internal" href="appendix.html#circleguard.loadables.Replay" title="circleguard.loadables.Replay"><code class="xref py py-class docutils literal notranslate"><span class="pre">Replay</span></code></a>s:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cg</span> <span class="o">=</span> <span class="n">Circleguard</span><span class="p">(</span><span class="s2">"key"</span><span class="p">,</span> <span class="n">db_path</span><span class="o">=</span><span class="s2">"./db.db"</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="mi">221777</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="s2">"1-2"</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cg</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="c1"># neither replay in `m` cached</span>
</pre></div>
</div>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="advanced-usage.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Advanced Usage</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="loading.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Loading</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
            |
            <a class="muted-link" href="_sources/caching.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Caching</a><ul>
<li><a class="reference internal" href="#slider-dir">slider_dir</a></li>
<li><a class="reference internal" href="#loadables">Loadables</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div>
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></body>
</html>